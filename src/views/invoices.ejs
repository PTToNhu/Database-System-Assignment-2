<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Liên kết tới file CSS -->

    <link rel="stylesheet" href="/css/invoices.css">
</head>

<body>

    <!-- Thanh điều hướng -->
    <nav>
        <a href="/">Home</a>
        <a href="/invoice" class="active">Invoice</a>
        <a href="/revenue" >Revenue</a>
        <a href="/order">Order</a>
        <a href="/customer">Customer</a>
    </nav>

    <!-- Biểu mẫu lọc -->
    <form id="filterForm" class="filter-form" action="/invoice" method="POST">
        <h1>Lọc danh sách hóa đơn theo thời gian, không gian</h1>
        <label for="startDate">Ngày bắt đầu:</label>
        <input type="date" id="startDate" name="startDate" required>

        <label for="endDate">Ngày kết thúc:</label>
        <input type="date" id="endDate" name="endDate" required>

        <label for="branch">Cơ sở:</label>
        <select id="branch" name="branch">
            <option value="">-- Chọn cơ sở (không bắt buộc) --</option>
            <% let branchCounter=1; %>
                <% branches.forEach(row=> { %>
                    <option value="<%= row.MACHINHANH %>">
                        <%= row.MACHINHANH %>
                    </option>
                    <% branchCounter++; }) %>
        </select>

        <button type="submit">Lọc</button>
    </form>

    <% if (invoices && invoices.length> 0) { %>
        <h1 class="h1-title">Bảng Hóa Đơn</h1>
        <table class="invoice-table">
            <thead>
                <tr>
                    <th>Mã Hóa Đơn</th>
                    <th>SĐT Khách Hàng</th>
                    <th>Tên Khách Hàng</th>
                    <% if (invoices[0].hasOwnProperty('MACHINHANH')) { %>
                        <th>Mã Chi Nhánh</th>
                        <th>Tên Chi Nhánh</th>
                        <% } %>
                            <th>Mã Nhân Viên</th>
                            <th>Tên Nhân Viên</th>
                            <th>Tổng Tiền</th>
                </tr>
            </thead>
            <tbody>
                <% invoices.forEach(row=> { %>
                    <tr>
                        <td>
                            <%= row.MAHOADON %>
                        </td>
                        <td>
                            <%= row.SDTKHACHHANG %>
                        </td>
                        <td>
                            <%= row.TENKHACHHANG %>
                        </td>
                        <% if (row.hasOwnProperty('MACHINHANH')) { %>
                            <td>
                                <%= row.MACHINHANH %>
                            </td>
                            <td>
                                <%= row.TENCHINHANH %>
                            </td>
                            <% } %>
                                <td>
                                    <%= row.MANV %>
                                </td>
                                <td>
                                    <%= row.TENNHANVIEN %>
                                </td>
                                <td>
                                    <%= Number.isInteger(row.TONGTIENHOADON) ? row.TONGTIENHOADON :
                                        row.TONGTIENHOADON.toFixed(1) %>
                                </td>
                    </tr>
                    <% }) %>
            </tbody>
        </table>
        <% } else { %>
            <% } %>

                <script>
                    document.getElementById('filterForm').addEventListener('submit', async function (event) {

                        // Lấy dữ liệu từ biểu mẫu
                        const formData = new FormData(this);

                        // Tạo một đối tượng để kiểm tra dữ liệu
                        const formObject = {};
                        formData.forEach((value, key) => {
                            formObject[key] = value;
                        });

                        // In ra dữ liệu thu thập từ biểu mẫu
                        console.log('Dữ liệu từ biểu mẫu:', formObject);
                        try {
                            const response = await fetch(this.action, {
                                method: this.method,
                                body: formData,
                            });

                            if (response.ok) {
                                const result = await response.text(); // Nhận phản hồi từ máy chủ
                                document.body.innerHTML = result; // Cập nhật nội dung trang
                            } else {
                                console.error('Có lỗi xảy ra khi gửi yêu cầu:', response.statusText);
                            }
                        } catch (error) {
                            console.error('Lỗi trong quá trình gửi yêu cầu:', error);
                        }
                    });
                </script>
</body>

</html>